---
- hosts: all
  become: yes
  become_user: root
  become_method: sudo

  tasks:

    - name: Garantindo /etc/hosts
      lineinfile:
        path: /etc/hosts
        line: "{{ item }}"
        state: present
      with_items:
        - 172.16.1.100 kube-master
        - 172.16.1.101 kube-node1
        - 172.16.1.102 kube-node2
        - 172.16.1.103 kube-infra
        - 172.16.1.202 docker-registry

    - name: Remove swap do arquivo /etc/fstab
      mount:
        name: "{{ item }}"
        fstype: swap
        state: absent
      with_items:
        - swap
        - none

    - name: Desativa o swap
      command: swapoff -a
      when: ansible_swaptotal_mb > 0

    - name: Cria arquivo containerd.conf
      copy:
        dest: /etc/modules-load.d/containerd.conf
        content: |
          overlay
          br_netfilter

    - name: Carrega módulos
      shell: modprobe overlay && modprobe br_netfilter

    - name: Cria arquivo sysctl para Kubernetes
      copy:
        dest: /etc/sysctl.d/kubernetes.conf
        content: |
          net.bridge.bridge-nf-call-ip6tables = 1
          net.bridge.bridge-nf-call-iptables = 1
          net.ipv4.ip_forward = 1

    - name: Aplica sysctl
      shell: sysctl --system

    - name: Adiciona usuário suporte
      user:
        name: suporte
        shell: /bin/bash
        password: "$1$QbUARykG$p2nthVG8AkDvabKPHwboa1"

    - name: Instala pacotes essenciais
      apt:
        name:
          - apt-transport-https
          - ca-certificates
          - curl
          - gnupg2
          - software-properties-common
          - mysql-client
          - nfs-common
          - snapd
          - git
          - vim
        state: present
        update_cache: yes

    - name: Clona repositório do curso
      git:
        repo: "https://github.com/4linux/541-kubernetes.git"
        dest: /home/suporte/541

    - name: Adiciona chave do Docker
      apt_key:
        url: https://download.docker.com/linux/ubuntu/gpg
        state: present

    - name: Adiciona repositório do Docker
      apt_repository:
        repo: deb [arch=amd64] https://download.docker.com/linux/ubuntu focal stable
        state: present

    - name: Instala Containerd
      apt:
        name: containerd.io
        state: present
        update_cache: yes

    - name: Cria config.toml do containerd
      shell: containerd config default | tee /etc/containerd/config.toml >/dev/null 2>&1

    - name: Ajusta SystemdCgroup = true
      replace:
        path: /etc/containerd/config.toml
        regexp: 'SystemdCgroup = false'
        replace: 'SystemdCgroup = true'

    - name: Habilita plugins no containerd
      replace:
        path: /etc/containerd/config.toml
        regexp: '^disabled_plugins ='
        replace: '#disabled_plugins ='

    - name: Reinicia containerd
      service:
        name: containerd
        state: restarted

    - name: Cria diretório de keys do Kubernetes
      file:
        path: /etc/apt/keyrings
        state: directory

    - name: Cria repositório Kubernetes
      copy:
        dest: /etc/apt/sources.list.d/kubernetes.list
        content: |
          deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v1.28/deb/ /

    - name: Importa chave apt do Kubernetes
      shell: |
        curl -fsSL https://pkgs.k8s.io/core:/stable:/v1.28/deb/Release.key \
        | gpg --dearmor --batch --yes -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg
      args:
        creates: /etc/apt/keyrings/kubernetes-apt-keyring.gpg

    - name: Instala pacotes Kubernetes
      apt:
        name:
          - kubelet
          - kubeadm
          - kubectl
        state: present
        update_cache: yes

    - name: Inicializa cluster Kubernetes via kubeadm
      shell: kubeadm init \
          --apiserver-advertise-address=172.16.1.100 \
          --pod-network-cidr=192.168.0.0/16 \
          --ignore-preflight-errors=all \
          > /opt/init_cluster
      args:
        creates: /opt/init_cluster
        
    - name: Configura KUBECONFIG para o usuário root (necessário para kubectl funcionar)
      become: yes
      shell: |
       mkdir -p /root/.kube
       cp -i /etc/kubernetes/admin.conf /root/.kube/config
       chown root:root /root/.kube/config
       
    - name: Configurar KUBECONFIG para o usuário vagrant
      become: yes
      shell: |
       mkdir -p /home/vagrant/.kube
       cp -i /etc/kubernetes/admin.conf /home/vagrant/.kube/config
       chown vagrant:vagrant /home/vagrant/.kube/config

    # CONFIG .kube PARA USUÁRIOS
    - name: Cria .kube para vagrant
      file:
        path: /home/vagrant/.kube
        state: directory

    - name: Copia kubeconfig vagrant
      copy:
        src: /etc/kubernetes/admin.conf
        dest: /home/vagrant/.kube/config
        remote_src: yes

    - name: Permissão arquivo kubeconfig vagrant
      file:
        path: /home/vagrant/.kube/config
        owner: vagrant
        group: vagrant
        mode: '0644'

    - name: Cria .kube para suporte
      file:
        path: /home/suporte/.kube
        state: directory
        owner: suporte
        group: suporte

    - name: Copia kubeconfig suporte
      copy:
        src: /etc/kubernetes/admin.conf
        dest: /home/suporte/.kube/config
        remote_src: yes

    - name: Permissão arquivo kubeconfig suporte
      file:
        path: /home/suporte/.kube/config
        owner: suporte
        group: suporte
        mode: '0644'
        
    # CALICO - Instalação direta
    - name: Download manifest Calico
      become: false
      get_url:
        url: https://raw.githubusercontent.com/projectcalico/calico/v3.26.1/manifests/calico.yaml
        dest: /home/vagrant/calico.yaml
        mode: '0644'

    - name: Ajusta CIDR do Calico
      become: false
      replace:
        path: /home/vagrant/calico.yaml
        regexp: '192\.168\.0\.0/16'
        replace: '192.168.0.0/16'

    - name: Instala Calico
      become: false
      command: kubectl apply -f /home/vagrant/calico.yaml

    - name: Aguarda node kube-master ficar Ready (após instalar CNI)
      become: false
      command: kubectl wait node kube-master --for=condition=Ready --timeout=300s
      register: wait_node_ready
      retries: 3
      delay: 10
      until: wait_node_ready.rc == 0
      changed_when: false

    - name: Permite master agendar Pods
      become: false
      command: kubectl taint nodes kube-master node-role.kubernetes.io/control-plane-

    - name: Gera token de join
      command: kubeadm token create --print-join-command
      register: join_command

    - name: Salva comando de join no host local
      local_action: copy content="{{ join_command.stdout_lines[0] }}" dest="./join-command"

