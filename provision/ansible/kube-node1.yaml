---
# Playbook final corrigido e automatizado para o ambiente Vagrant
# Grupos esperados no inventário: master, workers, all
# Uso: ansible-playbook -i inventory.ini k8s-playbook-final.yaml

- hosts: all
  become: yes
  vars:
    kubernetes_version_repo: "v1.28"
    pod_network_cidr: "192.168.0.0/16"
    calico_manifest_url: "https://docs.projectcalico.org/manifests/calico.yaml"
    calico_local_path: "/home/vagrant/calico.yaml"
  tasks:
    - name: Garantir /etc/hosts (entrada básica)
      lineinfile:
        path: /etc/hosts
        line: "{{ item }}"
        state: present
      loop:
        - 172.16.1.100 kube-master
        - 172.16.1.101 kube-node1
        - 172.16.1.102 kube-node2
        - 172.16.1.103 kube-infra
        - 172.16.1.202 docker-registry

    - name: Desabilitar swap (runtime)
      command: swapoff -a
      args:
        warn: false

    - name: Remover swap de fstab (idempotente)
      replace:
        path: /etc/fstab
        regexp: '(^.*\\s+swap\\s+.*$)'
        replace: '# swap disabled by ansible'
      ignore_errors: true

    - name: Criar /etc/modules-load.d/containerd.conf
      copy:
        dest: /etc/modules-load.d/containerd.conf
        content: |
          overlay
          br_netfilter

    - name: Carregar modulo overlay
      modprobe:
        name: overlay
        state: present

    - name: Carregar modulo br_netfilter
      modprobe:
        name: br_netfilter
        state: present

    - name: Criar sysctl para Kubernetes
      copy:
        dest: /etc/sysctl.d/k8s.conf
        content: |
          net.bridge.bridge-nf-call-ip6tables = 1
          net.bridge.bridge-nf-call-iptables = 1
          net.ipv4.ip_forward = 1

    - name: Aplicar sysctl
      command: sysctl --system

    - name: Instalar pacotes básicos
      apt:
        name:
          - apt-transport-https
          - ca-certificates
          - curl
          - gnupg
          - lsb-release
          - git
          - vim
        state: present
        update_cache: yes

    - name: Adicionar chave e repo Docker (para containerd)
      shell: |
        curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg
        echo "deb [arch=amd64 signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu focal stable" > /etc/apt/sources.list.d/docker.list
      args:
        warn: false

    - name: Instalar containerd
      apt:
        name: containerd.io
        state: present
        update_cache: yes

    - name: Criar config default do containerd
      command: containerd config default
      register: containerd_default

    - name: Escrever config.toml do containerd
      copy:
        dest: /etc/containerd/config.toml
        content: "{{ containerd_default.stdout }}"

    - name: Garantir SystemdCgroup true no containerd
      replace:
        path: /etc/containerd/config.toml
        regexp: 'SystemdCgroup = false'
        replace: 'SystemdCgroup = true'

    - name: Reiniciar containerd (garantia)
      systemd:
        name: containerd
        state: restarted
        enabled: yes

    - name: Preparar keyrings para Kubernetes apt
      file:
        path: /etc/apt/keyrings
        state: directory
        mode: '0755'

    - name: Adicionar repositório Kubernetes
      copy:
        dest: /etc/apt/sources.list.d/kubernetes.list
        content: "deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/{{ kubernetes_version_repo }}/deb/ /"

    - name: Importar chave GPG do Kubernetes
      shell: |
        curl -fsSL https://pkgs.k8s.io/core:/stable:/{{ kubernetes_version_repo }}/deb/Release.key | gpg --dearmor --batch --yes -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg
      args:
        warn: false
        creates: /etc/apt/keyrings/kubernetes-apt-keyring.gpg

    - name: Instalar kubeadm kubelet kubectl
      apt:
        name:
          - kubelet
          - kubeadm
          - kubectl
        state: present
        update_cache: yes

    - name: Segurar versões kube packages
      dpkg_selections:
        name: "{{ item }}"
        selection: hold
      loop:
        - kubelet
        - kubeadm
        - kubectl

    - name: Espera arquivo join-command existir
      stat:
        path: /vagrant/join-command
      register: join_file_stat
      until: join_file_stat.stat.exists
      retries: 30
      delay: 10

    - name: Ler e executar join command
      shell: "{{ lookup('file', '/vagrant/join-command') }}"
      args:
        warn: false
      register: join_output
      failed_when: join_output.rc != 0 and 'already' not in join_output.stderr

